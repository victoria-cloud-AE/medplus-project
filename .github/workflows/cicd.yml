# name: CI/CD - Build and Deploy to EC2

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-push:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Cache Docker layers
#         uses: actions/cache@v4
#         with:
#           path: /tmp/.buildx-cache
#           key: ${{ runner.os }}-buildx-${{ github.sha }}
#           restore-keys: |
#             ${{ runner.os }}-buildx-

#       - name: Configure AWS credentials
#         run: |
#           aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws configure set default.region ${{ secrets.AWS_REGION }}

#       - name: Login to Amazon ECR
#         run: |
#           aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 650891365688.dkr.ecr.us-east-1.amazonaws.com

#       - name: Build and Push Docker Image to ECR
#         run: |
#           docker build -t mediplus-repository:${{ github.run_number }} .
#           docker tag mediplus-repository:${{ github.run_number }} 650891365688.dkr.ecr.us-east-1.amazonaws.com/mediplus-repository:${{ github.run_number }}
#           docker push 650891365688.dkr.ecr.us-east-1.amazonaws.com/mediplus-repository:${{ github.run_number }}

#   deploy:
#     runs-on: ubuntu-latest
#     needs: build-push

#     steps:
#       - name: Deploy to EC2
#         env:
#           AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           AWS_REGION: ${{ secrets.AWS_REGION }}
#           GITHUB_RUN_NUMBER: ${{ github.run_number }}
#         run: |
#           # Save the SSH key
#           echo "${{ secrets.SSH_KEY }}" > mykey.pem
#           chmod 600 mykey.pem

#           # Store GitHub run number in a shell variable
#           RUN_NUMBER=${GITHUB_RUN_NUMBER:-1}

#           # Connect to EC2 and deploy
#           ssh -o StrictHostKeyChecking=no -i mykey.pem ubuntu@98.84.173.178 << EOF
#           echo "Starting deployment on EC2..."

#           # Export AWS credentials for non-interactive login
#           export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
#           export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
#           export AWS_REGION=${AWS_REGION}

#           echo "Logging into ECR..."
#           aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 650891365688.dkr.ecr.us-east-1.amazonaws.com

#           echo "Pulling new Docker image..."
#           docker pull 650891365688.dkr.ecr.us-east-1.amazonaws.com/mediplus-repository:$RUN_NUMBER

#           echo "Stopping old container if exists..."
#           docker rm -f mediplus-repository || true

#           echo "Running new container..."
#           docker run -d --name mediplus-repository -p 80:80 650891365688.dkr.ecr.us-east-1.amazonaws.com/mediplus-repository:$RUN_NUMBER

#           echo "Deployment complete!"
#           EOF









# name: Build and Push to ECR

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-push:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}

#       - name: Login to Amazon ECR
#         run: |
#           aws ecr get-login-password --region eu-north-1 | docker login --username AWS --password-stdin 892004491300.dkr.ecr.eu-north-1.amazonaws.com

#       - name: Build, tag, and push image to Amazon ECR
#         run: |
#           docker build -t mediplus:v1 .
#           docker tag mediplus:v1 892004491300.dkr.ecr.eu-north-1.amazonaws.com/mediplus:v1
#           docker push 892004491300.dkr.ecr.eu-north-1.amazonaws.com/mediplus:v1

